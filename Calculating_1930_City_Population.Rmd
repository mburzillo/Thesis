---
title: "Calculating 1930 City Populations"
author: "Maria Burzillo"
date: "12/13/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readr)
library(readxl)
library(sjmisc)
```

```{r import ipums data containing city and citypop for 1930 census, include = FALSE}

city_codebook_1930_full_sample <- read_excel("1930 City Population Data/city_codebook_1930_full_sample.xlsx") %>%
  select(-city_name)

# import list of all cities that have HOLC maps

all_cities_in_richmond <- read_excel("all_cities_in_richmond.xlsx")

# import data from 1930 full sample that I collapsed on Suz'z computer: hopefully this will be the final dataset...
ipums_full_sample_collapsed_1930 <- read_csv("1930 City Population Data/1930_data_ipums_full_sample_collapsed.csv")

```


```{r reshaping data to get 1 obs per city}

# Definition of CITY: CITY identifies the city of residence for households located in identifiable cities. The Comparability section provides a discussion of factors affecting which cities are identified and how well they are represented in each sample. The cities identified by CITY are generally consistent with U.S. Census "place" definitions. For an explanation and history of the concept, see Chapter 9 in the Census Bureau's Geographic Areas Reference Manual.

# Definition of CITYPOP: CITYPOP reports the population, in hundreds, for all identifiable cities. For Decennial Census samples, CITYPOP reports the counts collected in that Decennial Census. For the 2005 ACS sample, CITYPOP reports populations estimates derived for the 2005 ACS. For ACS samples from 2006-2011, CITYPOP reports population estimates derived from the 2006 ACS. For the 2012-onward ACS, CITYPOP reports population estimates derived from the ACS of that year. CITYPOP is a 5-digit numeric variable that reports the population, in hundreds, for all identifiable cities. For instance, a city having a population of 1,234,500 will have a CITYPOP value of 12345. For all samples prior to 1940 and the 1940 100% dataset, CITYPOP reports the population for all incorporated municipalities


# ipums_collapsed %>% filter(CITY == 1670)
# Q: what does it mean when citypop is given 0 for a city when perwt is non-zero?: seems like 0 corresponds to a city not identified or unincorporated place response. 
ipums_full_sample_collapsed_1930 <- ipums_full_sample_collapsed_1930  %>%
  rename(citypop_hundreds = citypop) %>%
  mutate(citypop_total = 100 * citypop_hundreds) 

# there are 8 cities which appear to have populations greater than 30,000 and yet do not have a citypop encoded. Should check later if any cities graded by HOLC are missing and see if they are one of these
ipums_full_sample_collapsed_1930 %>%
  filter(citypop_hundreds == 0, perwt > 30000)

# Brooklyn is not in sample (expected because codebook says it is only in sample before 1900)
ipums_full_sample_collapsed_1930 %>%
  filter(city == "4611")


```


```{r edit city codebook to merge with names, include = FALSE}

############### WITH FULL SAMPLE ##############

# these are the entries that do not have states/are irregular. 2 cities dropped below. Rest of cities just kept with NA for state
city_codebook_1930_full_sample_edited <- city_codebook_1930_full_sample %>%
  separate(city, c("city", "cityname"), sep = 4)  %>%
  # drop 1860 because no info in codebook and 0 because city could not be identified.
  filter(city != "0000") %>%
  filter(!(str_detect(cityname, ",")))
  


# Cleaning the full sample codebook (unclear if this is actually different from the 1%/5% one but want to be safe)  
city_codebook_1930_full_sample_edited <- city_codebook_1930_full_sample %>%
  # drop cities without city codes
  filter(city != "Georgetown, DC (See Washington, DC)", city != "Brooklyn, NY (See NYC)", 
         city != "Northern Liberties, PA (See Philadelphia)",
         city != "Southwark, PA (See Philadelphia)",
         city != "Spring Garden, PA (See Philadelphia)") %>%
  # separate city code from city name
  separate(city, c("city", "cityname"), sep = 4)  %>%
  # drop 1860 because no info in codebook and 0 because city could not be identified. Exclude city 1860 because city name is blank in codebook. Exclude Brooklyn (4611) because only in censuses before 1900 and so not relevant
  filter(city != "0000", city != "1860", city != "4611") %>%
  #separate city name from state name
  separate(cityname, c("cityname", "state"), ",") %>%
  # drop space before the state name
  separate(state, c("empty", "state"), sep = 1) %>%
  # drop anything after the state name
  separate(state, c("state", "drop"), sep = 2) %>%
  # drop excess rows/rows that have been separated
  select(-empty, -drop) %>%
  rename(CITY_old = city) %>%
  # remove leading zeros from city identifier name
  mutate(city = as.numeric(str_remove(CITY_old, "^0+")),
         cityname = trimws(cityname))

city_codebook_1930_full_sample_edited$cityname[city_codebook_1930_full_sample_edited$city == 2683] <- "Hanover township, Luzerne county"
city_codebook_1930_full_sample_edited$state[city_codebook_1930_full_sample_edited$city == 2683] <- "PA"

write.csv(city_codebook_1930_full_sample_edited , "city_codebook_1930_full_sample_edited")  
```



```{r join ipums data with city codebook, include = FALSE}

####### WITH FULL SAMPLE ###########

# joining codebook with full sample gives 984 cities/same number as in full collapsed sample -> looks good
ipums_1930_cities_by_pop_full_sample <- left_join(ipums_full_sample_collapsed_1930, city_codebook_1930_full_sample_edited)

# these cities correspond exactly to the cities between 30k and 40k that I had originally identified 
ipums_1930_cities_by_pop_full_sample %>%
  filter(citypop_total > 40000, citypop_total < 50000)

ipums_1930_cities_by_pop_full_sample %>%
  filter(citypop_total > 60000)


```

###############################################################

```{r join all cities in richmond to ipums data}

# join all cities with HOLC maps in Richmond with city population data from 1930. This will allow us to filter cities by various population cutoffs. First task will be to make sure that the cities that did not automcatically join correctly are corrected.

# create a new names variable to reflect any changes made to how they were originally in Richmond
all_cities_in_richmond$city_name_edited <- all_cities_in_richmond$City

# corrections based on spelling
all_cities_in_richmond$city_name_edited[all_cities_in_richmond$City == "East Saint Louis"] <- "East St. Louis"
all_cities_in_richmond$city_name_edited[all_cities_in_richmond$City == "Lake Co. Gary"] <- "Gary"

# joining correctly length-wise
city_pop_name_1930_in_richmond <- left_join(all_cities_in_richmond, ipums_1930_cities_by_pop_full_sample, by = c("city_name_edited" = "cityname", "state_ab" = "state")) %>%
  rename(city_code = city)


# with the initial join, it seems that only 20 cities did not join correctly -> likey a city designaiton or spelling mismatch error

city_pop_name_1930_in_richmond %>%
  filter(is.na(city_code))



# dropping some cities for now based on inability to match

cities_to_exclude = c("Stamford, Darien, and New Canaan", "Holyoke Chicopee")

city_pop_name_1930_in_richmond <- city_pop_name_1930_in_richmond %>%
  filter(!(City %in% cities_to_exclude))

# need to drop Lexington differently because also Lexington Kentucky here

city_pop_name_1930_in_richmond <- city_pop_name_1930_in_richmond[!(city_pop_name_1930_in_richmond$City == "Lexington" & city_pop_name_1930_in_richmond$state_ab == "MA"),]

city_pop_name_1930_in_richmond %>%
  filter(City == "Lexington")


city_pop_name_1930_in_richmond %>%
  filter(is.na(city_code))


######################## Notes on mismatches ##################################3
# East Saint Louis v. East St. Louis -> spelling uniformized 
# Stamford, Darien, and New Canaan (have data for Stamford but not Darien or New Canaan) -> exclude for now
# Lake Co. Gary Indiana seems a definitely match to Gary Indiana in IPUMS. Lake County is the county name that Gary is in. Not sure why the put that in the name but changing to just Gary
# Massachusetts	Holyoke Chicopee (Holyoke and Chicopee available separately. Pop of Chicopee IS 43,900. Population of Holyoke is 56500). Based on the maps, they seem to make up 1 larger urban area. Exclude for now but could be added back in later as part of the larger cities
# Lexington, MA is not in the city codebook. May not have been incorporated at the time according to census sheet, only population of 9k at the time. Exclude for now. Could be included later since part of the area mapped for Boston but...

ipums_1930_cities_by_pop_full_sample %>%
  filter(city == 2850)

```


```{r}
ipums_1930_cities_by_pop_full_sample
```

```{r left over from previous tries, include = FALSE}
# I checked the 5% sample for cities that are missing and say that the citypop variable is available, but there don't appear to be any...but... does seem like you can get them from the written-in published documents..

############  fixing any non-joins ###########

##### Potential Name Errors/True-Mis-matches
# Stamford, Darien, and New Canaan (have data for Stamford but not Darien or New Canaan)
# Indiana	Lake Co. Gary: Have data for Gary
# Massachusetts	Holyoke Chicopee (Holyoke and Chicopee available separately in 1930 5%)
# Missouri	Greater Kansas City (available as Kansas City)
# New Jersey	Bergen Co. (available as Bergen county, but not available any years)
# New Jersey	Essex Co. (not available)
# New Jersey	Hudson Co. (not available)
# New Jersey	Union Co. (union city is available, union also listed but no data)
# New York	Binghamton-Johnson City	NY (Binghamton available, Johnson city available)
# New York	Bronx	NY (no data)
# New York	Brooklyn (not available separate from NYC)
# New York	Lower Westchester Co.	(not available)
# New York	Manhattan (not available)
# New York	Queens (not available)
# New York	Staten Island (not available)
# Rhode Island	Pawtucket and Central Falls (Pawtucket and Central Falls available separately)

#### Seem to be missing overall, potentially go find in documents ####
# Massachusetts	Lexington (Not available/defined by Citypop in any year)



```


```{r look at stats for the successful matches}

# 143 successful matches
city_pop_name_1930_in_richmond %>%
  filter(!(is.na(city_code)))


# 2 towns with HOLC maps with populations between 30-40k
city_pop_name_1930_in_richmond %>%
  filter(!(is.na(city_code)), CITYPOP_total > 30000, CITYPOP_total < 40000)

# 26 towns with HOLC maps with populations between 40-50k
city_pop_name_1930_in_richmond %>%
  filter(!(is.na(city_code)), CITYPOP_total >= 40000, CITYPOP_total < 50000)

# 112 towns with HOLC maps with populations between above 50k
city_pop_name_1930_in_richmond %>%
  filter(!(is.na(city_code)), CITYPOP_total > 50000)

# 80 towns with HOLC maps with populations greater than 70k
city_pop_name_1930_in_richmond %>%
  filter(!(is.na(city_code)), CITYPOP_total > 70000)
  #ggplot(aes(x = CITYPOP_total)) +
  #geom_histogram()
  
# 44 towns with HOLC maps with populations between 70k and 150k
city_pop_name_1930_in_richmond %>%
  filter(!(is.na(city_code)), CITYPOP_total > 70000, CITYPOP_total < 150000)
  #ggplot(aes(x = CITYPOP_total)) +
  #geom_histogram()

```

```{r}

```

