---
title: "Demographic and Tract Merge"
author: "Maria Burzillo"
date: "11/8/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(rstanarm)
library(tidyverse)
```

```{r import data, include = FALSE}

# read in the IPUMS file with census tract level data on race and other deomgraphic characteristics

# initial data: sub-data
# nhgis0019_ds92_1960_tract <- read_csv("Demographic Data/nhgis0019_csv/nhgis0019_ds92_1960_tract.csv")

# load demographic data that contains all potential variables
nhgis0023_ds92_1960_tract <- read_csv("Demographic Data/1960 All Vars/nhgis0023_csv/nhgis0023_ds92_1960_tract.csv")


# rename file

race_1960_demo <- nhgis0023_ds92_1960_tract

```

```{r merge data, include = FALSE}

# join with the final data set with the tracts and HOLC grades from all_holc_files_cleaning

# all_cities_grade_demo <- left_join(all_cities_tract_grades, race_1960_demo, by = "GISJOIN")

all_cities_grade_demo <- left_join(all_richmond_with_pop, race_1960_demo, by = "GISJOIN") %>%
  select(-State, -City, -STATE) %>%
  rename(tract_year = year,
         demo_year = YEAR)

```


```{r renaming relevant vars based on codebook to work with, include = FALSE}

# initialize data for analysis, and we will add on columns from the joined data for the variables we need 
data_for_analysis <- all_cities_grade_demo

# variable encodings in format: description (universe)

# Total persons (persons) - Using the data from the printed report because the race data is from the printed report and want to keep consistent source

data_for_analysis$tot_persons_printed <- all_cities_grade_demo$B53001


# RACE from printed report (Persons)

data_for_analysis$white_printed <- all_cities_grade_demo$B7B001
data_for_analysis$black_printed <- all_cities_grade_demo$B7B002
data_for_analysis$other_printed <- all_cities_grade_demo$B7B003

# total foreign stock from printed report (foreign stock persons)

data_for_analysis$foreign_stock_printed <- all_cities_grade_demo$B7M001

# foreign born (foreign stock persons)

data_for_analysis$foreign_born <- all_cities_grade_demo$B8J001


# School completed (persons 25 yr and over)

data_for_analysis$no_school <- all_cities_grade_demo$B8R001
data_for_analysis$school_yr_1_4 <- all_cities_grade_demo$B8R002
data_for_analysis$school_yr_5_7 <- all_cities_grade_demo$B8R003
data_for_analysis$school_yr_8 <- all_cities_grade_demo$B8R004
data_for_analysis$school_yr_hs_1_3 <- all_cities_grade_demo$B8R005
data_for_analysis$school_yr_hs_4 <- all_cities_grade_demo$B8R006
data_for_analysis$school_yr_college_1_3 <- all_cities_grade_demo$B8R007
data_for_analysis$school_yr_college_p <- all_cities_grade_demo$B8R008


# family income in 1959 (families)

data_for_analysis$fam_income_less_1k <- all_cities_grade_demo$B8W001
data_for_analysis$fam_income_1_2k <- all_cities_grade_demo$B8W002
data_for_analysis$fam_income_2_3k <- all_cities_grade_demo$B8W003
data_for_analysis$fam_income_3_4k <- all_cities_grade_demo$B8W004
data_for_analysis$fam_income_4_5k <- all_cities_grade_demo$B8W005
data_for_analysis$fam_income_5_6k <- all_cities_grade_demo$B8W006
data_for_analysis$fam_income_6_7k <- all_cities_grade_demo$B8W007
data_for_analysis$fam_income_7_8k <- all_cities_grade_demo$B8W008
data_for_analysis$fam_income_8_9k <- all_cities_grade_demo$B8W009
data_for_analysis$fam_income_9_10k <- all_cities_grade_demo$B8W010
data_for_analysis$fam_income_10_15k <- all_cities_grade_demo$B8W011
data_for_analysis$fam_income_15_25k <- all_cities_grade_demo$B8W012
data_for_analysis$fam_income_25k_p <- all_cities_grade_demo$B8W013


# Total Housing Units (h units)
data_for_analysis$tot_hunits <- all_cities_grade_demo$CA5001


# N owner occupied (occupied year round h units)
data_for_analysis$owner_occupied <- all_cities_grade_demo$B8F001

# N renter occupied (occupied year round h units)
data_for_analysis$renter_occupied <- all_cities_grade_demo$B8F002


# N vacant for rent (vacant year-round housing units)
data_for_analysis$vacant_for_rent<- all_cities_grade_demo$B8Q001
# N vacant for sale (vacant year-round housing units)
data_for_analysis$vacant_for_sale <- all_cities_grade_demo$B8Q002


# Occupied Units by Persons per Room (occupied units)
data_for_analysis$persons_per_room_half_or_less <- all_cities_grade_demo$B76001
data_for_analysis$persons_per_room_point51_point75 <- all_cities_grade_demo$B76002
data_for_analysis$persons_per_room_point76_one<- all_cities_grade_demo$B76003
data_for_analysis$persons_per_room_onepone_or_more <- all_cities_grade_demo$B76004


# renter occupied unit aggregate monthly contract rent

data_for_analysis$agg_monthly_contract_rent <- all_cities_grade_demo$B8B001

# value of property from printed report (housing units)


data_for_analysis$property_value_u5k <- all_cities_grade_demo$B7O001
data_for_analysis$property_value_5000_7400 <- all_cities_grade_demo$B7O002
data_for_analysis$property_value_7500_9900 <- all_cities_grade_demo$B7O003
data_for_analysis$property_value_10000_12400 <- all_cities_grade_demo$B7O004
data_for_analysis$property_value_12500_14900 <- all_cities_grade_demo$B7O005
data_for_analysis$property_value_15000_17400 <- all_cities_grade_demo$B7O006
data_for_analysis$property_value_17500_19900 <- all_cities_grade_demo$B7O007
data_for_analysis$property_value_20000_24900 <- all_cities_grade_demo$B7O008
data_for_analysis$property_value_25000_34900 <- all_cities_grade_demo$B7O009
data_for_analysis$property_value_35000_plus <- all_cities_grade_demo$B7O0010


# units in structure (housing units)

data_for_analysis$units_1 <- all_cities_grade_demo$B92001
data_for_analysis$units_2 <- all_cities_grade_demo$B92002
data_for_analysis$units_3_4 <- all_cities_grade_demo$B92003
data_for_analysis$units_5_9 <- all_cities_grade_demo$B92004
data_for_analysis$units_10_P <- all_cities_grade_demo$B92005


# year structure built (all housing units)

data_for_analysis$built_1950_1960 <- all_cities_grade_demo$B98001
data_for_analysis$built_1940_1949 <- all_cities_grade_demo$B98002
data_for_analysis$built_pre_1940 <- all_cities_grade_demo$B98003



# year head moved into household (occupied housing units)

data_for_analysis$moved_1958_1960 <- all_cities_grade_demo$CAJ001
data_for_analysis$moved_in_1954_1957 <- all_cities_grade_demo$CAJ002
data_for_analysis$moved_in_1940_1953 <- all_cities_grade_demo$CAJ003
data_for_analysis$moved_in_pre_1940 <- all_cities_grade_demo$CAJ004

# persons in group quarters from printed report (persons in hhs)

data_for_analysis$persons_group_quarters<- all_cities_grade_demo$B54001


# housing by condition

data_for_analysis$condition_sound <- all_cities_grade_demo$B67001
data_for_analysis$condition_deteriorated <- all_cities_grade_demo$B67002
data_for_analysis$condition_dilapidated <- all_cities_grade_demo$B67003


# % African American
# % non-white
# % immigrants

# age of structure

# housing value

defined = c("B53001", "B7B001", "B7B002", "B7B003", "B7M001", "B8J001", "B8R001", 
            "B8R002", "B8R003", "B8R004", "B8R005", "B8R006", "B8R007", "B8R008",
            "B8W001", "B8W002", "B8W003", "B8W004", "B8W005", "B8W006", "B8W007",
            "B8W008", "B8W009", "B8W010", "B8W011", "B8W012", "B8W013", "CA5001",
            "B8F001", "B8F002", "B8Q001", "B8Q002", "B76001", "B76002", "B76003", 
            "B76004", "B8B001", "B7O001", "B7O002", "B7O003", "B7O004", "B7O005",
            "B7O006", "B7O007", "B7O008", "B7O009", "B7O010", "B92001", "B92002",
            "B92003", "B92004", "B92005", "B98001", "B98002", "B98003", "CAJ001",
            "CAJ002", "CAJ003", "CAJ004", "B54001", "B67001", "B67002", "B67003")


filtered <- data_for_analysis %>%
  select(!(defined)) %>%
  view()

colnames(filtered)


```


```{r creating additional variables relevant for analysis, include = FALSE}

# pct non-white
data_for_analysis$pct_non_white_printed <- (data_for_analysis$black_printed +
                                      data_for_analysis$other_printed)/data_for_analysis$tot_persons_printed * 100

# pct black
data_for_analysis$pct_black_printed <- (data_for_analysis$black_printed)/data_for_analysis$tot_persons_printed * 100


# % foreign stock
data_for_analysis$pct_foreign_stock_printed<- (data_for_analysis$foreign_stock_printed)/data_for_analysis$tot_persons_printed * 100

# % foreign born
data_for_analysis$pct_foreign_born <- (data_for_analysis$foreign_born)/data_for_analysis$tot_persons_printed * 100

# pct hs grads

# calculate total persons who have school data
data_for_analysis$tot_school_persons <- data_for_analysis$no_school + data_for_analysis$school_yr_1_4  +
  data_for_analysis$school_yr_5_7 + data_for_analysis$school_yr_8 + data_for_analysis$school_yr_hs_1_3 +
  data_for_analysis$school_yr_hs_4 + data_for_analysis$school_yr_college_1_3 +
  data_for_analysis$school_yr_college_p

# calculate total persons whose highest edu attainment is hs completion or greater
data_for_analysis$tot_hs_grads <- data_for_analysis$school_yr_hs_4 +
  data_for_analysis$school_yr_college_1_3 +
  data_for_analysis$school_yr_college_p

# calculate hs grads
data_for_analysis$pct_hs_grad <- data_for_analysis$tot_hs_grads/data_for_analysis$tot_school_persons * 100


# need to calculate income next -> how to choose something for this?? https://www.census.gov/data/tables/time-series/demo/income-poverty/historical-poverty-people.html

# based on the above source, the pverty level for families of 3 in 1959 was 2,324 -> create indicator of below or above 3k income, roughly the poverty line for a family of 3. 

# average household size according to the census in 1960 was 3.29 https://www.census.gov/library/publications/1962/dec/pc-s1-23.html#:~:text=The%20number%20of%20households%20in,of%20household%20was%203.29%20persons.

# sum families with income in 1959 <3k and then divide by total # families


data_for_analysis$all_families_with_income_data <- data_for_analysis$fam_income_less_1k + data_for_analysis$fam_income_1_2k + data_for_analysis$fam_income_2_3k +
data_for_analysis$fam_income_3_4k + data_for_analysis$fam_income_4_5k + data_for_analysis$fam_income_5_6k +
data_for_analysis$fam_income_6_7k + data_for_analysis$fam_income_7_8k + data_for_analysis$fam_income_8_9k +
data_for_analysis$fam_income_9_10k + data_for_analysis$fam_income_10_15k + data_for_analysis$fam_income_15_25k +
data_for_analysis$fam_income_25k_p

data_for_analysis$all_families_with_income_lt_3k <- data_for_analysis$fam_income_less_1k + data_for_analysis$fam_income_1_2k + data_for_analysis$fam_income_2_3k 

data_for_analysis$pct_families_below_3k_income <- (data_for_analysis$all_families_with_income_lt_3k/
                                                     data_for_analysis$all_families_with_income_data) * 100


```



```{r}
all_cities_grade_demo  %>%
  ggplot(aes(x = pct_black, y= rounded_tract_holc_grade)) +
  geom_point() +
  geom_smooth(se = FALSE)

data_for_analysis  %>%
  ggplot(aes(x = pct_black_printed, y= prop_grade_D)) +
  geom_point() +
  geom_smooth(se = FALSE)
  
```



```{r}
all_cities_grade_demo  %>%
  ggplot(aes(x = pct_white, y= rounded_tract_holc_grade)) +
  geom_point() +
  geom_smooth(se = FALSE)
```

```{r export data, include = FALSE}
#write.csv(all_cities_grade_demo, "all_cities_grade_demo.csv")
write.csv(data_for_analysis, "data_for_analysis.csv")
```


```{r}
m1 <- stan_glm(all_cities_grade_demo$rounded_tract_holc_grade ~ all_cities_grade_demo$pct_black)
print(m1,3)
```


