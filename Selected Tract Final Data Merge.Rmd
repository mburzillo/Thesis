---
title: "Selected Tract Census FInal Data Merge"
author: "Maria Burzillo"
date: "2/7/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

```{r load data}

# load demographic data that contains all potential variables
nhgis0023_ds92_1960_tract <- read_csv("Demographic Data/1960 All Vars/nhgis0023_csv/nhgis0023_ds92_1960_tract.csv")

potential_treatment <- read_csv("selected_treatment.csv")

potential_control <- read_csv("potential_control.csv")

state_abs <- read_csv("50_us_states_all_data.csv")

```

```{r joining tract data, demo data, and city population data}

# drop geometry and add a treatment indicator for both datasets
potential_treatment <- potential_treatment %>%
  select(-wkt_geom) %>%
  mutate(treatment = factor(1))

potential_control <- potential_control %>%
  select(-wkt_geom) %>%
  mutate(treatment = factor(0))

# join treatment and control to get one dataset
potential_tracts <- rbind(potential_control, potential_treatment) 

# join with the demographic data
potential_tracts_demo <- left_join(potential_tracts, nhgis0023_ds92_1960_tract, by = "GISJOIN") 

# take relevant columns from city pop data
city_names_pops_1930 <- ipums_1930_cities_by_pop_full_sample %>%
  select(cityname, state, citypop_total_1930 = citypop_total)

city_names_pops_1930 <- left_join(city_names_pops_1930, state_abs, by = c("state" = "state_ab"))


potential_tracts_demo <- left_join(potential_tracts_demo, city_names_pops_1930, by = c("NAME" = "cityname", "STATE.x" = "state.y"))

```


```{r sanity checks on joins}

# checking joins
potential_tracts_demo %>%
  group_by(STATE.x, NAME, citypop_total_1930) %>%
  summarise(mean(citypop_total_1930), median(citypop_total_1930))

potential_tracts_demo %>%
  filter(is.na(citypop_total_1930))


```


```{r OLD - use if restricting within radius}
# this actually doesn't do anything because it seems like everything intersected correctly
treatment_within_r <- treatment_demo %>%
  group_by(STATE.x, PLACE, GISJOIN) %>%
  summarise(tot_area_intersecting = sum(area),
            prop_within_radius = tot_area_intersecting/SHAPE_AREA,
            within_r = ifelse(prop_within_radius == 1, 1, 0),
            within_r_75 = ifelse(prop_within_radius >= .75, 1, 0),
            within_r_50 = ifelse(prop_within_radius >= .50, 1, 0))


# 404 tracts completely inside radii
sum(treatment_within_r$within_r)
# 588 75% within
sum(treatment_within_r$within_r_75)
# 644 50% within
sum(treatment_within_r$within_r_50)
```

```{r calculate statistics and rename relevant rows}
# Total persons (persons) - Using the data from the printed report because the race data is from the printed report and want to keep consistent source
potential_tracts_demo$tot_persons_printed <- potential_tracts_demo$B53001

# calculate population density (originally in meters squared area so scale to km)
potential_tracts_demo$pop_density <- potential_tracts_demo$tot_persons_printed/potential_tracts_demo$SHAPE_AREA * 1000000
```


```{r dropping tracts with low density}

tracts_selected <- potential_tracts_demo %>%
  filter(pop_density >= 952.4427)

```


```{r looking at summary statistics}

tracts_selected %>%
  mutate(count = 1) %>%
  group_by(treatment) %>%
  summarise(n_tracts = sum(count))

unique(tracts_selected$treatment)

```



```{r prop_grade_d}

tracts_selected %>%
  ggplot(aes(x = pop_density, fill = treatment)) +
  geom_histogram(bins = 100) +
  facet_wrap(~treatment)

```

```{r}
tracts_selected %>%
  ggplot(aes(x = pop_density, color = treatment)) +
  geom_density()

```

```{r}
tracts_selected %>%
  group_by(NAME, treatment) %>%
  summarise(citypop_1930_ = mean(citypop_total_1930)) %>%
  ggplot(aes(x = citypop_1930_, color = treatment)) +
  geom_density()
```

```{r}
tracts_selected %>%
  group_by(NAME, treatment) %>%
  summarise(citypop_1930_ = mean(citypop_total_1930)) %>%
  ggplot(aes(x = citypop_1930_, fill = treatment)) +
  geom_histogram(bins = 100)
```
